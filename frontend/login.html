<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login - ReportApp</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    
    .login-container {
      background: white;
      padding: 50px 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 100%;
    }
    
    .login-container h1 {
      margin: 0 0 30px 0;
      text-align: center;
      color: #667eea;
      font-size: 32px;
    }
    
    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .login-form input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
      box-sizing: border-box;
    }
    
    .login-form input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .login-form button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .login-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    
    .login-form button:active {
      transform: translateY(0);
    }
    
    .db-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 16px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    
    .db-indicator:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    
    .db-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      backdrop-filter: blur(4px);
    }
    
    .db-modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 450px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .db-modal-content h2 {
      margin: 0 0 25px 0;
      color: #667eea;
      font-size: 24px;
    }
    
    .db-modal-content label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    
    .db-modal-content input[type="text"],
    .db-modal-content input[type="password"] {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    .db-modal-content input[type="text"]:focus,
    .db-modal-content input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .db-modal-content input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .db-modal-content button {
      margin-top: 20px;
      margin-right: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .db-modal-content button[type="submit"] {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .db-modal-content button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .db-modal-content button[type="button"] {
      background: #6c757d;
      color: white;
    }
    
    .db-modal-content button[type="button"]:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div id="dbIndicator" class="db-indicator">ðŸ”§ DB: Loading...</div>
  
  <div id="dbModal" class="db-modal">
    <div class="db-modal-content">
      <h2>Database Connection</h2>
      <form id="dbForm">
        <label>Admin Password (required)</label>
        <input type="password" id="adminPwd" required placeholder="Enter 1234567890" />
        
        <label>ODBC Driver</label>
        <select id="dbDriver">
          <option value="ODBC Driver 18 for SQL Server" selected>ODBC Driver 18 for SQL Server</option>
          <option value="ODBC Driver 17 for SQL Server">ODBC Driver 17 for SQL Server</option>
        </select>

        <label>SQL Server</label>
        <input type="text" id="dbHost" placeholder="SERVER\INSTANCE" required />
        
        <label>Database</label>
        <input type="text" id="dbName" placeholder="Database name" required />
        
        <label>
          <input type="checkbox" id="dbTrusted" checked /> Use Windows Authentication
        </label>
        
        <div id="sqlAuthFields" style="display:none;">
          <label>Username</label>
          <input type="text" id="dbUser" placeholder="SQL Server username" />
          
          <label>Password</label>
          <input type="password" id="dbPass" placeholder="SQL Server password" />
        </div>
        
        <button type="submit">Save & Test</button>
        <button type="button" onclick="closeDbModal()">Cancel</button>
      </form>
    </div>
  </div>
  
  <div class="login-container">
    <h1>ReportApp</h1>
    <form id="loginForm" class="login-form">
      <label>Username</label>
      <input id="u" name="username" placeholder="Enter your username" required />
      <label>Password</label>
      <input id="p" name="password" type="password" placeholder="Enter your password" required />
      <button type="submit">Sign In</button>
    </form>
  </div>
  
  <script>
    const dbIndicator = document.getElementById('dbIndicator');
    const dbModal = document.getElementById('dbModal');
    const loginForm = document.getElementById('loginForm');
    const loginButton = loginForm.querySelector('button[type="submit"]');
    
    // Load database info on page load
    async function loadDbInfo() {
      try {
        const res = await fetch('/settings/info');
        if (res.ok) {
          const data = await res.json();
          if (data.configured) {
            dbIndicator.textContent = `ðŸ”§ DB: ${data.database} on ${data.host}`;
          } else {
            dbIndicator.textContent = 'ðŸ”§ DB: Not Configured';
          }
        }
      } catch (e) {
        dbIndicator.textContent = 'ðŸ”§ DB: Error';
      }
    }
    
    // Show DB modal when clicking indicator
    dbIndicator.onclick = function() {
      dbModal.style.display = 'block';
      loadCurrentSettings();
    };
    
    function closeDbModal() {
      dbModal.style.display = 'none';
    }
    
    // Close modal when clicking outside
    dbModal.onclick = function(e) {
      if (e.target === dbModal) closeDbModal();
    };
    
    // Toggle SQL Auth fields
    document.getElementById('dbTrusted').onchange = function() {
      document.getElementById('sqlAuthFields').style.display = this.checked ? 'none' : 'block';
    };
    
    // Load current settings
    async function loadCurrentSettings() {
      try {
        const res = await fetch('/settings/info');
        if (res.ok) {
          const data = await res.json();
          if (data.configured) {
            document.getElementById('dbHost').value = data.host || '';
            document.getElementById('dbName').value = data.database || '';
            document.getElementById('dbTrusted').checked = data.trusted || false;
            document.getElementById('dbUser').value = data.username || '';
            document.getElementById('sqlAuthFields').style.display = data.trusted ? 'none' : 'block';
            if (data.driver) {
              document.getElementById('dbDriver').value = data.driver;
            }
          }
        }
      } catch (e) {
        console.error('Failed to load settings', e);
      }
    }
    
    // Handle DB form submission
    document.getElementById('dbForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const adminPwd = document.getElementById('adminPwd').value;
      // Quick client-side check (server also enforces)
      if (!adminPwd) {
        alert('Admin password is required');
        return;
      }
      
      const payload = {
        adminPassword: adminPwd,
        driver: document.getElementById('dbDriver').value,
        host: document.getElementById('dbHost').value,
        database: document.getElementById('dbName').value,
        trusted: document.getElementById('dbTrusted').checked,
        username: document.getElementById('dbUser').value || null,
        password: document.getElementById('dbPass').value || null
      };
      
      try {
        const res = await fetch('/settings/save', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          const data = await res.json();
          alert(data.message || 'Settings saved successfully');
          closeDbModal();
          loadDbInfo();
        } else {
          const err = await res.json();
          alert('Failed to save: ' + (err.detail || 'Unknown error'));
        }
      } catch (e) {
        alert('Error saving settings: ' + e.message);
      }
    };
    
    // Login form submission
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      
      // Disable button and show loading state
      loginButton.disabled = true;
      loginButton.textContent = 'Signing In...';
      
      const u = document.getElementById('u').value;
      const p = document.getElementById('p').value;
      
      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username: u, password: p})
        });
        
        if (res.ok) {
          const data = await res.json();
          if (data.token) {
            sessionStorage.setItem('token', data.token);
            sessionStorage.setItem('role', data.role || 'user');
            sessionStorage.setItem('username', u);
            if (data.must_change_password) {
              sessionStorage.setItem('forceChangePassword', '1');
            } else {
              sessionStorage.removeItem('forceChangePassword');
            }
            window.location.href = '/';
          } else {
            alert('Login failed: No token received');
            loginButton.disabled = false;
            loginButton.textContent = 'Sign In';
          }
        } else {
          alert('Login failed: Invalid credentials');
          loginButton.disabled = false;
          loginButton.textContent = 'Sign In';
        }
      } catch (e) {
        alert('Login error: ' + e.message);
        loginButton.disabled = false;
        loginButton.textContent = 'Sign In';
      }
    };
    
    // Initialize
    loadDbInfo();
  </script>
</body>
</html>
